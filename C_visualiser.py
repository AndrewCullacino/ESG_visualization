"""
Strategy C Visualizer - ESG Supply Chain Analysis
===================================================
This visualizer creates comprehensive charts for Strategy C (Zone III - Learning Zone)
using the exported CSV data from the ML simulation.

Zone III Focus: Low-emission, high-cooperation suppliers
- Knowledge sharing and innovation
- Best practice dissemination
- Network effects and learning
"""

import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.patches as mpatches
from matplotlib import rcParams
import numpy as np
import os

# Chinese font configuration
rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'PingFang SC', 'STHeiti']
rcParams['axes.unicode_minus'] = False

# ============================================================================
# Data Loading
# ============================================================================

def load_data():
    """Load all CSV files generated by the ML simulation"""
    
    try:
        pathway_df = pd.read_csv('ML_simulation_C_ä¸‰å¹´å‡æ’è·¯å¾„.csv', encoding='utf-8-sig')
        classification_df = pd.read_csv('ML_simulation_C_å››è±¡é™åˆ†ç±».csv', encoding='utf-8-sig')
        budget_df = pd.read_csv('ML_simulation_C_æŠ•èµ„é¢„ç®—åˆ†é….csv', encoding='utf-8-sig')
        tech_db = pd.read_csv('ML_simulation_C_æŠ€æœ¯æ•°æ®åº“.csv', encoding='utf-8-sig')
        knowledge_db = pd.read_csv('ML_simulation_C_çŸ¥è¯†å…±äº«æ•°æ®åº“.csv', encoding='utf-8-sig')
        summary_df = pd.read_csv('ML_simulation_C_strategy_summary.csv', encoding='utf-8-sig')
        
        print("âœ“ All data files loaded successfully")
        return pathway_df, classification_df, budget_df, tech_db, knowledge_db, summary_df
        
    except FileNotFoundError as e:
        print(f"âŒ Error: Could not find data file: {e}")
        print("Please run C_strategy_ML_simulation.py first to generate the data files.")
        return None, None, None, None, None, None


# ============================================================================
# Chart 1: Knowledge Transfer & Cooperation Improvement
# ============================================================================

def plot_knowledge_transfer_analysis(budget_df, classification_df):
    """Analyze knowledge transfer effectiveness and cooperation patterns"""
    
    fig, ((ax1, ax2), (ax3, ax4)) = plt.subplots(2, 2, figsize=(16, 12))
    
    # Merge data
    merged_df = pd.merge(budget_df, classification_df, on='ä¾›åº”å•†')
    
    # Chart 1.1: Knowledge Multiplier vs Network Effect
    scatter1 = ax1.scatter(merged_df['çŸ¥è¯†å€å¢å™¨'], 
                          merged_df['ç½‘ç»œæ•ˆåº”'],
                          s=merged_df['é¢„æœŸå‡æ’é‡'] * 2,
                          c=merged_df['åˆ›æ–°æ½œåŠ›'],
                          cmap='YlGn',
                          alpha=0.6,
                          edgecolors='black',
                          linewidth=1)
    
    ax1.set_xlabel('çŸ¥è¯†å€å¢å™¨ (Knowledge Multiplier)', fontsize=12, weight='bold')
    ax1.set_ylabel('ç½‘ç»œæ•ˆåº” (Network Effect)', fontsize=12, weight='bold')
    ax1.set_title('çŸ¥è¯†è½¬ç§»æ•ˆèƒ½åˆ†æ\nKnowledge Transfer Effectiveness', 
                  fontsize=14, weight='bold', pad=15)
    ax1.grid(True, alpha=0.3, linestyle='--')
    
    cbar1 = plt.colorbar(scatter1, ax=ax1)
    cbar1.set_label('åˆ›æ–°æ½œåŠ›', fontsize=10, weight='bold')
    
    # Chart 1.2: Investment Distribution (Tech vs Knowledge)
    suppliers_top10 = budget_df.nlargest(10, 'é¢„æœŸå‡æ’é‡')['ä¾›åº”å•†']
    top10_data = budget_df[budget_df['ä¾›åº”å•†'].isin(suppliers_top10)]
    
    x_pos = np.arange(len(top10_data))
    width = 0.35
    
    bars1 = ax2.bar(x_pos - width/2, top10_data['æŠ€æœ¯æŠ•èµ„'], width, 
                    label='æŠ€æœ¯æŠ•èµ„', color='steelblue', alpha=0.8, edgecolor='black')
    bars2 = ax2.bar(x_pos + width/2, top10_data['çŸ¥è¯†æŠ•èµ„'], width,
                    label='çŸ¥è¯†æŠ•èµ„', color='orange', alpha=0.8, edgecolor='black')
    
    ax2.set_xlabel('ä¾›åº”å•†', fontsize=12, weight='bold')
    ax2.set_ylabel('æŠ•èµ„é‡‘é¢ (USD)', fontsize=12, weight='bold')
    ax2.set_title('Top 10 ä¾›åº”å•†æŠ•èµ„åˆ†é…\nInvestment Distribution', 
                  fontsize=14, weight='bold', pad=15)
    ax2.set_xticks(x_pos)
    ax2.set_xticklabels([s.split('_')[-1] for s in top10_data['ä¾›åº”å•†']], 
                        rotation=45, ha='right')
    ax2.legend(fontsize=10)
    ax2.grid(True, alpha=0.3, axis='y')
    
    # Chart 1.3: Innovation Potential Distribution
    innovation_bins = [0, 0.3, 0.5, 0.7, 0.9, 1.0]
    innovation_labels = ['å¾ˆä½', 'ä½', 'ä¸­', 'é«˜', 'å¾ˆé«˜']
    merged_df['åˆ›æ–°ç­‰çº§'] = pd.cut(merged_df['åˆ›æ–°æ½œåŠ›'], 
                                  bins=innovation_bins, 
                                  labels=innovation_labels)
    
    innovation_counts = merged_df['åˆ›æ–°ç­‰çº§'].value_counts().sort_index()
    colors_innovation = ['#d62728', '#ff7f0e', '#ffdd57', '#2ca02c', '#1f77b4']
    
    wedges, texts, autotexts = ax3.pie(innovation_counts.values,
                                        labels=innovation_counts.index,
                                        colors=colors_innovation,
                                        autopct='%1.1f%%',
                                        startangle=90,
                                        explode=[0.05] * len(innovation_counts))
    
    for autotext in autotexts:
        autotext.set_color('white')
        autotext.set_weight('bold')
        autotext.set_fontsize(11)
    
    ax3.set_title('åˆ›æ–°æ½œåŠ›åˆ†å¸ƒ\nInnovation Potential Distribution', 
                  fontsize=14, weight='bold', pad=15)
    
    # Chart 1.4: Knowledge Transfer Score vs Reduction Rate
    scatter2 = ax4.scatter(merged_df['çŸ¥è¯†è½¬ç§»å¾—åˆ†'],
                          merged_df['å‡æ’ç‡'],
                          s=merged_df['æ€»æŠ•èµ„'] * 0.3,
                          c=merged_df['é…åˆç¨‹åº¦'],
                          cmap='plasma',
                          alpha=0.6,
                          edgecolors='black',
                          linewidth=1)
    
    ax4.set_xlabel('çŸ¥è¯†è½¬ç§»å¾—åˆ† (Knowledge Transfer Score)', fontsize=12, weight='bold')
    ax4.set_ylabel('å‡æ’ç‡ (%)', fontsize=12, weight='bold')
    ax4.set_title('çŸ¥è¯†è½¬ç§»ä¸å‡æ’æ•ˆæœ\nKnowledge Transfer vs Reduction', 
                  fontsize=14, weight='bold', pad=15)
    ax4.grid(True, alpha=0.3, linestyle='--')
    
    cbar2 = plt.colorbar(scatter2, ax=ax4)
    cbar2.set_label('é…åˆç¨‹åº¦', fontsize=10, weight='bold')
    
    plt.suptitle('CåŒºçŸ¥è¯†è½¬ç§»ä¸é…åˆåº¦ç»¼åˆåˆ†æ (Zone III: Learning Zone)\nKnowledge Transfer & Cooperation Analysis', 
                 fontsize=16, weight='bold', y=0.98)
    plt.tight_layout()
    
    output_path = 'CåŒºçŸ¥è¯†è½¬ç§»ç»¼åˆåˆ†æ_ML_data.png'
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"âœ“ Chart saved: {output_path}")
    
    return fig


# ============================================================================
# Chart 2: Investment ROI & Network Effects Analysis
# ============================================================================

def plot_investment_roi_analysis(budget_df, summary_df):
    """Analyze investment ROI and network effects for Zone III"""
    
    fig, ((ax1, ax2), (ax3, ax4)) = plt.subplots(2, 2, figsize=(16, 12))
    
    # Merge data
    merged_df = pd.merge(budget_df, summary_df, on='ä¾›åº”å•†')
    
    # Chart 2.1: Top 10 suppliers by ROI
    top10_roi = merged_df.nlargest(10, 'æŠ•èµ„å›æŠ¥ç‡')
    
    colors_roi = plt.cm.RdYlGn(np.linspace(0.3, 0.9, len(top10_roi)))
    bars = ax1.barh(range(len(top10_roi)), top10_roi['æŠ•èµ„å›æŠ¥ç‡'],
                    color=colors_roi, alpha=0.8, edgecolor='black', linewidth=1.5)
    
    ax1.set_yticks(range(len(top10_roi)))
    ax1.set_yticklabels([s.split('_')[-1] for s in top10_roi['ä¾›åº”å•†']])
    ax1.set_xlabel('æŠ•èµ„å›æŠ¥ç‡ (%)', fontsize=12, weight='bold')
    ax1.set_ylabel('ä¾›åº”å•†', fontsize=12, weight='bold')
    ax1.set_title('Top 10 æŠ•èµ„å›æŠ¥ç‡æ’å\nTop 10 ROI Ranking', 
                  fontsize=14, weight='bold', pad=15)
    ax1.grid(True, alpha=0.3, axis='x')
    
    # Add value labels
    for i, (bar, value) in enumerate(zip(bars, top10_roi['æŠ•èµ„å›æŠ¥ç‡'])):
        ax1.text(value + 1, i, f'{value:.1f}%', 
                va='center', ha='left', fontsize=9, weight='bold')
    
    # Chart 2.2: Network Effect Impact
    # Use _x suffix for columns from budget_df (first dataframe in merge)
    network_col = 'ç½‘ç»œæ•ˆåº”_x' if 'ç½‘ç»œæ•ˆåº”_x' in merged_df.columns else 'ç½‘ç»œæ•ˆåº”'
    knowledge_col = 'çŸ¥è¯†å€å¢å™¨_x' if 'çŸ¥è¯†å€å¢å™¨_x' in merged_df.columns else 'çŸ¥è¯†å€å¢å™¨'
    investment_col = 'æ€»æŠ•èµ„_x' if 'æ€»æŠ•èµ„_x' in merged_df.columns else 'æ€»æŠ•èµ„'
    
    scatter1 = ax2.scatter(merged_df[network_col],
                          merged_df['å‡æ’é‡'],
                          s=merged_df[investment_col] * 0.5,
                          c=merged_df[knowledge_col],
                          cmap='viridis',
                          alpha=0.6,
                          edgecolors='black',
                          linewidth=1)
    
    ax2.set_xlabel('ç½‘ç»œæ•ˆåº” (Network Effect)', fontsize=12, weight='bold')
    ax2.set_ylabel('å‡æ’é‡ (tons COâ‚‚)', fontsize=12, weight='bold')
    ax2.set_title('ç½‘ç»œæ•ˆåº”å¯¹å‡æ’çš„å½±å“\nNetwork Effect Impact on Reduction', 
                  fontsize=14, weight='bold', pad=15)
    ax2.grid(True, alpha=0.3, linestyle='--')
    
    cbar1 = plt.colorbar(scatter1, ax=ax2)
    cbar1.set_label('çŸ¥è¯†å€å¢å™¨', fontsize=10, weight='bold')
    
    # Chart 2.3: Payback Period Distribution
    valid_payback = merged_df[merged_df['å›æœ¬å‘¨æœŸ(å¹´)'] < 20]  # Filter outliers
    
    ax3.hist(valid_payback['å›æœ¬å‘¨æœŸ(å¹´)'], bins=15, color='teal', 
            alpha=0.7, edgecolor='black', linewidth=1.5)
    
    mean_payback = valid_payback['å›æœ¬å‘¨æœŸ(å¹´)'].mean()
    ax3.axvline(mean_payback, color='red', linestyle='--', linewidth=2.5,
               label=f'å¹³å‡: {mean_payback:.1f}å¹´')
    
    ax3.set_xlabel('å›æœ¬å‘¨æœŸ (å¹´)', fontsize=12, weight='bold')
    ax3.set_ylabel('ä¾›åº”å•†æ•°é‡', fontsize=12, weight='bold')
    ax3.set_title('æŠ•èµ„å›æœ¬å‘¨æœŸåˆ†å¸ƒ\nPayback Period Distribution', 
                  fontsize=14, weight='bold', pad=15)
    ax3.legend(fontsize=11)
    ax3.grid(True, alpha=0.3, axis='y')
    
    # Chart 2.4: Cost-Effectiveness Analysis
    investment_col = 'æ€»æŠ•èµ„_x' if 'æ€»æŠ•èµ„_x' in merged_df.columns else 'æ€»æŠ•èµ„'
    merged_df['æˆæœ¬æ•ˆç›Š'] = merged_df['å‡æ’é‡'] / merged_df[investment_col]
    top8_efficiency = merged_df.nlargest(8, 'æˆæœ¬æ•ˆç›Š')
    
    x_pos = np.arange(len(top8_efficiency))
    bars2 = ax4.bar(x_pos, top8_efficiency['æˆæœ¬æ•ˆç›Š'],
                   color='seagreen', alpha=0.8, edgecolor='black', linewidth=1.5)
    
    ax4.set_xticks(x_pos)
    ax4.set_xticklabels([s.split('_')[-1] for s in top8_efficiency['ä¾›åº”å•†']],
                       rotation=45, ha='right')
    ax4.set_xlabel('ä¾›åº”å•†', fontsize=12, weight='bold')
    ax4.set_ylabel('æˆæœ¬æ•ˆç›Š (tons COâ‚‚ / USD)', fontsize=12, weight='bold')
    ax4.set_title('Top 8 æˆæœ¬æ•ˆç›Šåˆ†æ\nTop 8 Cost-Effectiveness', 
                  fontsize=14, weight='bold', pad=15)
    ax4.grid(True, alpha=0.3, axis='y')
    
    # Add value labels
    for i, (bar, value) in enumerate(zip(bars2, top8_efficiency['æˆæœ¬æ•ˆç›Š'])):
        ax4.text(i, value + 0.001, f'{value:.4f}',
                ha='center', va='bottom', fontsize=9, weight='bold')
    
    plt.suptitle('CåŒºæŠ•èµ„å›æŠ¥ä¸ç½‘ç»œæ•ˆåº”åˆ†æ (Zone III: Learning Zone)\nInvestment ROI & Network Effects', 
                 fontsize=16, weight='bold', y=0.98)
    plt.tight_layout()
    
    output_path = 'CåŒºæŠ•èµ„å›æŠ¥ä¸ç½‘ç»œæ•ˆåº”åˆ†æ_ML_data.png'
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"âœ“ Chart saved: {output_path}")
    
    return fig


# ============================================================================
# Chart 3: Three-Year Emission Pathway (Top 8)
# ============================================================================

def plot_emission_pathway(pathway_df, summary_df):
    """Plot three-year emission reduction pathways for top 8 suppliers"""
    
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(18, 7))
    
    # Get top 8 suppliers by total reduction
    top8_suppliers = summary_df.nlargest(8, 'å‡æ’é‡')['ä¾›åº”å•†'].tolist()
    
    # Chart 3.1: Emission pathways
    colors = plt.cm.viridis(np.linspace(0.1, 0.9, 8))
    year_mapping = {'åŸºçº¿å¹´': 0, 'ç¬¬1å¹´': 1, 'ç¬¬2å¹´': 2, 'ç¬¬3å¹´': 3}
    
    for idx, supplier in enumerate(top8_suppliers):
        supplier_data = pathway_df[pathway_df['ä¾›åº”å•†'] == supplier].copy()
        supplier_data['å¹´ä»½æ•°å€¼'] = supplier_data['å¹´ä»½'].map(year_mapping)
        supplier_data = supplier_data.sort_values('å¹´ä»½æ•°å€¼')
        
        ax1.plot(supplier_data['å¹´ä»½æ•°å€¼'], supplier_data['ç¢³æ’æ”¾(å¨CO2)'],
                marker='o', linewidth=2.5, markersize=8, color=colors[idx],
                label=supplier.split('_')[-1], alpha=0.8)
    
    ax1.set_xticks([0, 1, 2, 3])
    ax1.set_xticklabels(['åŸºçº¿å¹´', 'ç¬¬1å¹´', 'ç¬¬2å¹´', 'ç¬¬3å¹´'])
    ax1.set_xlabel('å¹´ä»½', fontsize=12, weight='bold')
    ax1.set_ylabel('ç¢³æ’æ”¾é‡ (tons COâ‚‚)', fontsize=12, weight='bold')
    ax1.set_title('Top 8 ä¾›åº”å•†ä¸‰å¹´å‡æ’è·¯å¾„\nTop 8 Three-Year Emission Pathway',
                  fontsize=14, weight='bold', pad=15)
    ax1.legend(loc='upper right', fontsize=9, ncol=2)
    ax1.grid(True, alpha=0.3, linestyle='--')
    
    # Chart 3.2: Cumulative reduction
    for idx, supplier in enumerate(top8_suppliers):
        supplier_data = pathway_df[pathway_df['ä¾›åº”å•†'] == supplier].copy()
        supplier_data['å¹´ä»½æ•°å€¼'] = supplier_data['å¹´ä»½'].map(year_mapping)
        supplier_data = supplier_data.sort_values('å¹´ä»½æ•°å€¼')
        
        ax2.plot(supplier_data['å¹´ä»½æ•°å€¼'], supplier_data['ç´¯è®¡å‡æ’é‡(å¨CO2)'],
                marker='s', linewidth=2.5, markersize=8, color=colors[idx],
                label=supplier.split('_')[-1], alpha=0.8)
    
    ax2.set_xticks([0, 1, 2, 3])
    ax2.set_xticklabels(['åŸºçº¿å¹´', 'ç¬¬1å¹´', 'ç¬¬2å¹´', 'ç¬¬3å¹´'])
    ax2.set_xlabel('å¹´ä»½', fontsize=12, weight='bold')
    ax2.set_ylabel('ç´¯è®¡å‡æ’é‡ (tons COâ‚‚)', fontsize=12, weight='bold')
    ax2.set_title('Top 8 ä¾›åº”å•†ç´¯è®¡å‡æ’é‡\nTop 8 Cumulative Reduction',
                  fontsize=14, weight='bold', pad=15)
    ax2.legend(loc='upper left', fontsize=9, ncol=2)
    ax2.grid(True, alpha=0.3, linestyle='--')
    
    plt.suptitle('CåŒºä¸‰å¹´å‡æ’è·¯å¾„åˆ†æ (Zone III: Learning Zone)\nThree-Year Emission Reduction Pathway',
                 fontsize=16, weight='bold', y=1.00)
    plt.tight_layout()
    
    output_path = 'CåŒºä¸‰å¹´å‡æ’è·¯å¾„_Top8_ML_data.png'
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"âœ“ Chart saved: {output_path}")
    
    return fig


# ============================================================================
# Chart 4: Technology & Knowledge Initiative Analysis
# ============================================================================

def plot_technology_knowledge_analysis(tech_db, knowledge_db, summary_df, budget_df):
    """Analyze technology adoption and knowledge initiatives"""
    
    fig = plt.figure(figsize=(18, 10))
    gs = fig.add_gridspec(2, 3, hspace=0.3, wspace=0.3)
    
    # Chart 4.1: Technology Effectiveness
    ax1 = fig.add_subplot(gs[0, 0])
    
    if 'æŠ€æœ¯åç§°' in tech_db.columns:
        tech_db_sorted = tech_db.sort_values('å‡æ’ç‡', ascending=True)
        
        colors_tech = plt.cm.RdYlGn(np.linspace(0.3, 0.9, len(tech_db_sorted)))
        bars = ax1.barh(range(len(tech_db_sorted)), tech_db_sorted['å‡æ’ç‡'] * 100,
                       color=colors_tech, alpha=0.8, edgecolor='black', linewidth=1)
        
        ax1.set_yticks(range(len(tech_db_sorted)))
        ax1.set_yticklabels(tech_db_sorted['æŠ€æœ¯åç§°'], fontsize=8)
        ax1.set_xlabel('å‡æ’ç‡ (%)', fontsize=11, weight='bold')
        ax1.set_title('æŠ€æœ¯å‡æ’æ•ˆæœ\nTechnology Effectiveness', fontsize=12, weight='bold')
        ax1.grid(True, alpha=0.3, axis='x')
    
    # Chart 4.2: Knowledge Transfer Value
    ax2 = fig.add_subplot(gs[0, 1])
    
    if 'çŸ¥è¯†è½¬ç§»ä»·å€¼' in tech_db.columns:
        scatter = ax2.scatter(tech_db['å•ä½æˆæœ¬'] / 1000, 
                             tech_db['çŸ¥è¯†è½¬ç§»ä»·å€¼'],
                             s=tech_db['å‡æ’ç‡'] * 1000,
                             c=tech_db['å¹´åº¦è¿è¥èŠ‚çœ'],
                             cmap='coolwarm',
                             alpha=0.6,
                             edgecolors='black',
                             linewidth=1)
        
        ax2.set_xlabel('å•ä½æˆæœ¬ (åƒUSD)', fontsize=11, weight='bold')
        ax2.set_ylabel('çŸ¥è¯†è½¬ç§»ä»·å€¼', fontsize=11, weight='bold')
        ax2.set_title('æŠ€æœ¯æˆæœ¬ vs çŸ¥è¯†ä»·å€¼\nCost vs Knowledge Value', fontsize=12, weight='bold')
        ax2.grid(True, alpha=0.3)
        
        cbar = plt.colorbar(scatter, ax=ax2)
        cbar.set_label('å¹´åº¦èŠ‚çœ', fontsize=9)
    
    # Chart 4.3: Knowledge Initiative Impact
    ax3 = fig.add_subplot(gs[0, 2])
    
    if 'å€¡è®®åç§°' in knowledge_db.columns:
        x_pos = np.arange(len(knowledge_db))
        width = 0.35
        
        bars1 = ax3.bar(x_pos - width/2, knowledge_db['çŸ¥è¯†å€å¢å™¨'],
                       width, label='çŸ¥è¯†å€å¢å™¨', color='steelblue', alpha=0.8)
        bars2 = ax3.bar(x_pos + width/2, knowledge_db['ç½‘ç»œæ•ˆåº”'],
                       width, label='ç½‘ç»œæ•ˆåº”', color='orange', alpha=0.8)
        
        ax3.set_xticks(x_pos)
        ax3.set_xticklabels(knowledge_db['å€¡è®®åç§°'], rotation=45, ha='right', fontsize=8)
        ax3.set_ylabel('æ•ˆæœå€¼', fontsize=11, weight='bold')
        ax3.set_title('çŸ¥è¯†å…±äº«å€¡è®®æ•ˆæœ\nKnowledge Initiative Impact', fontsize=12, weight='bold')
        ax3.legend(fontsize=9)
        ax3.grid(True, alpha=0.3, axis='y')
    
    # Chart 4.4: Technology vs Knowledge Investment
    ax4 = fig.add_subplot(gs[1, 0])
    
    tech_total = budget_df['æŠ€æœ¯æŠ•èµ„'].sum()
    knowledge_total = budget_df['çŸ¥è¯†æŠ•èµ„'].sum()
    
    sizes = [tech_total, knowledge_total]
    labels = [f'æŠ€æœ¯æŠ•èµ„\n${tech_total:,.0f}', f'çŸ¥è¯†æŠ•èµ„\n${knowledge_total:,.0f}']
    colors_pie = ['steelblue', 'orange']
    explode = (0.05, 0.05)
    
    wedges, texts, autotexts = ax4.pie(sizes, labels=labels, colors=colors_pie,
                                        autopct='%1.1f%%', startangle=90,
                                        explode=explode)
    
    for autotext in autotexts:
        autotext.set_color('white')
        autotext.set_weight('bold')
        autotext.set_fontsize(12)
    
    ax4.set_title('æŠ•èµ„åˆ†é…æ¯”ä¾‹\nInvestment Distribution', fontsize=12, weight='bold')
    
    # Chart 4.5: Success Rate by Initiative Count
    ax5 = fig.add_subplot(gs[1, 1])
    
    merged_data = pd.merge(budget_df, summary_df, on='ä¾›åº”å•†')
    initiative_success = merged_data.groupby('çŸ¥è¯†å€¡è®®æ•°')['æ˜¯å¦è¾¾æ ‡'].apply(
        lambda x: (x == 'æ˜¯').sum() / len(x) * 100
    ).reset_index()
    
    bars = ax5.bar(initiative_success['çŸ¥è¯†å€¡è®®æ•°'], 
                   initiative_success['æ˜¯å¦è¾¾æ ‡'],
                   color='seagreen', alpha=0.8, edgecolor='black', linewidth=1.5)
    
    ax5.set_xlabel('çŸ¥è¯†å€¡è®®æ•°é‡', fontsize=11, weight='bold')
    ax5.set_ylabel('è¾¾æ ‡ç‡ (%)', fontsize=11, weight='bold')
    ax5.set_title('å€¡è®®æ•°é‡ä¸æˆåŠŸç‡\nInitiatives vs Success Rate', fontsize=12, weight='bold')
    ax5.grid(True, alpha=0.3, axis='y')
    
    for bar in bars:
        height = bar.get_height()
        ax5.text(bar.get_x() + bar.get_width()/2., height,
                f'{height:.1f}%', ha='center', va='bottom', fontsize=10, weight='bold')
    
    # Chart 4.6: Overall Statistics
    ax6 = fig.add_subplot(gs[1, 2])
    ax6.axis('off')
    
    total_suppliers = len(summary_df)
    success_count = (summary_df['æ˜¯å¦è¾¾æ ‡'] == 'æ˜¯').sum()
    success_rate = success_count / total_suppliers * 100
    avg_reduction = summary_df['å‡æ’é‡'].mean()
    avg_reduction_rate = summary_df['å‡æ’ç‡'].mean()
    avg_knowledge_multiplier = budget_df['çŸ¥è¯†å€å¢å™¨'].mean()
    
    stats_text = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  CåŒº ç»Ÿè®¡æ‘˜è¦ (Zone III)  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š ä¾›åº”å•†æ€»æ•°: {total_suppliers}

âœ… è¾¾æ ‡æƒ…å†µ:
  â€¢ è¾¾æ ‡æ•°: {success_count}
  â€¢ è¾¾æ ‡ç‡: {success_rate:.1f}%

ğŸ“‰ å‡æ’æ•ˆæœ:
  â€¢ å¹³å‡å‡æ’: {avg_reduction:.0f} tons
  â€¢ å¹³å‡å‡æ’ç‡: {avg_reduction_rate:.1f}%

ğŸ§  çŸ¥è¯†è½¬ç§»:
  â€¢ å¹³å‡å€å¢å™¨: {avg_knowledge_multiplier:.2f}x

ğŸ’° æŠ•èµ„æ•ˆç‡:
  â€¢ æŠ€æœ¯æŠ•èµ„: ${tech_total:,.0f}
  â€¢ çŸ¥è¯†æŠ•èµ„: ${knowledge_total:,.0f}
  â€¢ æ€»è®¡: ${tech_total + knowledge_total:,.0f}
    """
    
    ax6.text(0.1, 0.5, stats_text, fontsize=10, family='monospace',
            verticalalignment='center',
            bbox=dict(boxstyle='round', facecolor='lightblue', alpha=0.3))
    
    plt.suptitle('CåŒºæŠ€æœ¯ä¸çŸ¥è¯†å€¡è®®ç»¼åˆåˆ†æ (Zone III: Learning Zone)\nTechnology & Knowledge Initiative Analysis',
                 fontsize=16, weight='bold', y=0.98)
    
    output_path = 'CåŒºæŠ€æœ¯çŸ¥è¯†ç»¼åˆåˆ†æ_ML_data.png'
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"âœ“ Chart saved: {output_path}")
    
    return fig


# ============================================================================
# Main Execution
# ============================================================================

def main():
    print("\n" + "="*80)
    print("STRATEGY C VISUALIZER - Zone III (Learning Zone) Data Analysis")
    print("="*80 + "\n")
    
    # Load data
    print("ğŸ“ Loading data files...")
    pathway_df, classification_df, budget_df, tech_db, knowledge_db, summary_df = load_data()
    
    if pathway_df is None:
        return
    
    print(f"\nğŸ“Š Data loaded:")
    print(f"  - {len(pathway_df)} pathway records")
    print(f"  - {len(classification_df)} supplier classifications")
    print(f"  - {len(budget_df)} budget allocations")
    print(f"  - {len(tech_db)} technologies")
    print(f"  - {len(knowledge_db)} knowledge initiatives")
    print(f"  - {len(summary_df)} summary records")
    
    # Generate visualizations
    print("\nğŸ“ˆ Generating visualizations...\n")
    
    print("1ï¸âƒ£  Creating knowledge transfer & cooperation analysis...")
    fig1 = plot_knowledge_transfer_analysis(budget_df, classification_df)
    
    print("2ï¸âƒ£  Creating investment ROI & network effects analysis...")
    fig2 = plot_investment_roi_analysis(budget_df, summary_df)
    
    print("3ï¸âƒ£  Creating three-year emission pathway...")
    fig3 = plot_emission_pathway(pathway_df, summary_df)
    
    print("4ï¸âƒ£  Creating technology & knowledge initiative analysis...")
    fig4 = plot_technology_knowledge_analysis(tech_db, knowledge_db, summary_df, budget_df)
    
    print("\n" + "="*80)
    print("âœ… All visualizations generated successfully!")
    print("="*80)
    
    # Calculate and display summary statistics
    print("\nğŸ“Š SUMMARY STATISTICS:")
    print(f"  Total Suppliers: {len(summary_df)}")
    print(f"  Total Baseline Emissions: {classification_df['å¹´ç¢³æ’æ”¾(å¨CO2)'].sum():,.0f} tons COâ‚‚")
    print(f"  Total Reduction: {summary_df['å‡æ’é‡'].sum():,.0f} tons COâ‚‚")
    print(f"  Average Reduction Rate: {summary_df['å‡æ’ç‡'].mean():.2f}%")
    print(f"  Success Rate: {(summary_df['æ˜¯å¦è¾¾æ ‡'] == 'æ˜¯').sum() / len(summary_df) * 100:.1f}%")
    print(f"  Total Investment: ${budget_df['æ€»æŠ•èµ„'].sum():,.0f}")
    print(f"  Average Knowledge Multiplier: {budget_df['çŸ¥è¯†å€å¢å™¨'].mean():.2f}x")
    print(f"  Average Network Effect: {budget_df['ç½‘ç»œæ•ˆåº”'].mean():.2f}")
    print(f"  Average Innovation Potential: {budget_df['åˆ›æ–°æ½œåŠ›'].mean():.2f}")
    
    plt.show()
    
    print("\nâœ¨ Visualization complete! Charts have been saved to the current directory.")


if __name__ == "__main__":
    main()
