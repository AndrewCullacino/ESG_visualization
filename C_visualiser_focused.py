"""
Strategy C Focused Visualizer - Technology & Knowledge Sharing Analysis
========================================================================
This visualizer creates focused charts for Strategy C (Zone III - Learning Zone)
analyzing technology effectiveness and knowledge sharing initiatives.

Zone III Focus: Low-emission, high-cooperation suppliers
- Technology effectiveness analysis
- Knowledge initiative impact
- Success rate correlation
"""

import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.patches as mpatches
from matplotlib import rcParams
import numpy as np
import os

# Chinese font configuration
rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'PingFang SC', 'STHeiti']
rcParams['axes.unicode_minus'] = False

# ============================================================================
# Data Loading
# ============================================================================

def load_data():
    """Load all CSV files generated by the ML simulation"""
    
    try:
        budget_df = pd.read_csv('ML_simulation_C_æŠ•èµ„é¢„ç®—åˆ†é….csv', encoding='utf-8-sig')
        tech_db = pd.read_csv('ML_simulation_C_æŠ€æœ¯æ•°æ®åº“.csv', encoding='utf-8-sig')
        knowledge_db = pd.read_csv('ML_simulation_C_çŸ¥è¯†å…±äº«æ•°æ®åº“.csv', encoding='utf-8-sig')
        summary_df = pd.read_csv('ML_simulation_C_strategy_summary.csv', encoding='utf-8-sig')
        
        print("âœ“ All data files loaded successfully")
        return budget_df, tech_db, knowledge_db, summary_df
        
    except FileNotFoundError as e:
        print(f"âŒ Error: Could not find data file: {e}")
        print("Please run C_strategy_ML_simulation.py first to generate the data files.")
        return None, None, None, None


# ============================================================================
# Chart 1: Technology Effectiveness (æŠ€æœ¯å‡æ’æ•ˆæœ)
# ============================================================================

def plot_technology_effectiveness(tech_db):
    """Plot horizontal bar chart showing technology effectiveness by reduction rate"""
    
    fig, ax = plt.subplots(figsize=(10, 8))
    
    # Sort technologies by reduction rate
    tech_db_sorted = tech_db.sort_values('å‡æ’ç‡', ascending=True)
    
    # Create color gradient from light to dark green
    colors_tech = plt.cm.YlGn(np.linspace(0.4, 0.9, len(tech_db_sorted)))
    
    # Create horizontal bar chart
    y_pos = np.arange(len(tech_db_sorted))
    bars = ax.barh(y_pos, tech_db_sorted['å‡æ’ç‡'] * 100,
                   color=colors_tech, alpha=0.85, edgecolor='black', linewidth=1.2)
    
    # Set labels
    ax.set_yticks(y_pos)
    ax.set_yticklabels(tech_db_sorted['æŠ€æœ¯åç§°'], fontsize=11)
    ax.set_xlabel('å‡æ’ç‡ (%)', fontsize=13, weight='bold')
    ax.set_title('æŠ€æœ¯å‡æ’æ•ˆæœ\nTechnology Effectiveness', fontsize=15, weight='bold', pad=20)
    ax.grid(True, alpha=0.3, axis='x', linestyle='--')
    
    # Add value labels on bars
    for i, (bar, value) in enumerate(zip(bars, tech_db_sorted['å‡æ’ç‡'] * 100)):
        ax.text(value + 0.15, i, f'{value:.1f}%',
                va='center', ha='left', fontsize=9, weight='bold')
    
    plt.tight_layout()
    
    output_path = 'CåŒº_æŠ€æœ¯å‡æ’æ•ˆæœ.png'
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"âœ“ Chart 1 saved: {output_path}")
    
    return fig


# ============================================================================
# Chart 2: Knowledge Transfer vs Reduction (çŸ¥è¯†è½¬ç§»ä¸å‡æ’æ•ˆæœ)
# ============================================================================

def plot_knowledge_transfer_vs_reduction(budget_df):
    """Plot scatter chart showing correlation between knowledge transfer score and reduction rate"""
    
    fig, ax = plt.subplots(figsize=(10, 8))
    
    # Create scatter plot with bubble size based on total investment
    scatter = ax.scatter(budget_df['çŸ¥è¯†è½¬ç§»å¾—åˆ†'],
                        budget_df['å‡æ’ç‡'],
                        s=budget_df['æ€»æŠ•èµ„'] * 0.8,  # Bubble size
                        c=budget_df['é…åˆç¨‹åº¦'] if 'é…åˆç¨‹åº¦' in budget_df.columns else budget_df['çŸ¥è¯†å€å¢å™¨'],
                        cmap='plasma',
                        alpha=0.6,
                        edgecolors='black',
                        linewidth=1.5)
    
    # Set labels and title
    ax.set_xlabel('çŸ¥è¯†è½¬ç§»å¾—åˆ† (Knowledge Transfer Score)', fontsize=13, weight='bold')
    ax.set_ylabel('å‡æ’ç‡ (%)', fontsize=13, weight='bold')
    ax.set_title('çŸ¥è¯†è½¬ç§»ä¸å‡æ’æ•ˆæœ\nKnowledge Transfer vs Reduction', fontsize=15, weight='bold', pad=20)
    ax.grid(True, alpha=0.3, linestyle='--')
    
    # Add colorbar
    cbar = plt.colorbar(scatter, ax=ax)
    cbar.set_label('é…åˆç¨‹åº¦' if 'é…åˆç¨‹åº¦' in budget_df.columns else 'çŸ¥è¯†å€å¢å™¨', 
                   fontsize=11, weight='bold')
    
    # Add trend line
    z = np.polyfit(budget_df['çŸ¥è¯†è½¬ç§»å¾—åˆ†'], budget_df['å‡æ’ç‡'], 1)
    p = np.poly1d(z)
    x_trend = np.linspace(budget_df['çŸ¥è¯†è½¬ç§»å¾—åˆ†'].min(), budget_df['çŸ¥è¯†è½¬ç§»å¾—åˆ†'].max(), 100)
    ax.plot(x_trend, p(x_trend), "r--", alpha=0.8, linewidth=2, label='è¶‹åŠ¿çº¿')
    ax.legend(fontsize=10)
    
    plt.tight_layout()
    
    output_path = 'CåŒº_çŸ¥è¯†è½¬ç§»ä¸å‡æ’æ•ˆæœ.png'
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"âœ“ Chart 2 saved: {output_path}")
    
    return fig


# ============================================================================
# Chart 3: Knowledge Initiative Impact (çŸ¥è¯†å…±äº«å€¡è®®æ•ˆæœ)
# ============================================================================

def plot_knowledge_initiative_impact(knowledge_db):
    """Plot grouped bar chart showing knowledge multiplier and network effect for each initiative"""
    
    fig, ax = plt.subplots(figsize=(12, 7))
    
    # Prepare data
    x_pos = np.arange(len(knowledge_db))
    width = 0.35
    
    # Create grouped bars
    bars1 = ax.bar(x_pos - width/2, knowledge_db['çŸ¥è¯†å€å¢å™¨'],
                   width, label='çŸ¥è¯†å€å¢å™¨', color='steelblue', alpha=0.85, edgecolor='black', linewidth=1.2)
    bars2 = ax.bar(x_pos + width/2, knowledge_db['ç½‘ç»œæ•ˆåº”'],
                   width, label='ç½‘ç»œæ•ˆåº”', color='orange', alpha=0.85, edgecolor='black', linewidth=1.2)
    
    # Set labels and title
    ax.set_xticks(x_pos)
    ax.set_xticklabels(knowledge_db['å€¡è®®åç§°'], rotation=30, ha='right', fontsize=10)
    ax.set_ylabel('æ•ˆæœå€¼', fontsize=13, weight='bold')
    ax.set_title('çŸ¥è¯†å…±äº«å€¡è®®æ•ˆæœ\nKnowledge Initiative Impact', fontsize=15, weight='bold', pad=20)
    ax.legend(fontsize=11, loc='upper left')
    ax.grid(True, alpha=0.3, axis='y', linestyle='--')
    
    # Add value labels on bars
    for bars in [bars1, bars2]:
        for bar in bars:
            height = bar.get_height()
            ax.text(bar.get_x() + bar.get_width()/2., height,
                   f'{height:.2f}',
                   ha='center', va='bottom', fontsize=9, weight='bold')
    
    plt.tight_layout()
    
    output_path = 'CåŒº_çŸ¥è¯†å…±äº«å€¡è®®æ•ˆæœ.png'
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"âœ“ Chart 3 saved: {output_path}")
    
    return fig


# ============================================================================
# Chart 4: Initiatives vs Success Rate (å€¡è®®æ•°é‡ä¸æˆåŠŸç‡)
# ============================================================================

def plot_initiatives_vs_success_rate(budget_df, summary_df):
    """Plot line/bar chart showing relationship between number of initiatives and success rate"""
    
    fig, ax = plt.subplots(figsize=(10, 7))
    
    # Merge dataframes
    merged_data = pd.merge(budget_df, summary_df, on='ä¾›åº”å•†')
    
    # Calculate success rate by initiative count
    initiative_success = merged_data.groupby('çŸ¥è¯†å€¡è®®æ•°').agg({
        'æ˜¯å¦è¾¾æ ‡': lambda x: (x == 'æ˜¯').sum() / len(x) * 100 if len(x) > 0 else 0,
        'ä¾›åº”å•†': 'count'  # Count of suppliers
    }).reset_index()
    initiative_success.columns = ['çŸ¥è¯†å€¡è®®æ•°é‡', 'è¾¾æ ‡ç‡', 'ä¾›åº”å•†æ•°é‡']
    
    # Create bar chart
    bars = ax.bar(initiative_success['çŸ¥è¯†å€¡è®®æ•°é‡'], 
                  initiative_success['è¾¾æ ‡ç‡'],
                  color='seagreen', alpha=0.8, edgecolor='black', linewidth=1.5,
                  width=0.6)
    
    # Add line connecting the bars
    ax.plot(initiative_success['çŸ¥è¯†å€¡è®®æ•°é‡'], initiative_success['è¾¾æ ‡ç‡'],
           color='darkgreen', marker='o', linewidth=2.5, markersize=8, alpha=0.7)
    
    # Set labels and title
    ax.set_xlabel('çŸ¥è¯†å€¡è®®æ•°é‡', fontsize=13, weight='bold')
    ax.set_ylabel('è¾¾æ ‡ç‡ (%)', fontsize=13, weight='bold')
    ax.set_title('å€¡è®®æ•°é‡ä¸æˆåŠŸç‡\nInitiatives vs Success Rate', fontsize=15, weight='bold', pad=20)
    ax.grid(True, alpha=0.3, axis='y', linestyle='--')
    
    # Set x-axis to show integer ticks
    ax.set_xticks(initiative_success['çŸ¥è¯†å€¡è®®æ•°é‡'])
    
    # Add value labels on bars
    for i, (bar, value, count) in enumerate(zip(bars, initiative_success['è¾¾æ ‡ç‡'], initiative_success['ä¾›åº”å•†æ•°é‡'])):
        height = bar.get_height()
        # Show percentage
        ax.text(bar.get_x() + bar.get_width()/2., height + 0.5,
               f'{value:.1f}%',
               ha='center', va='bottom', fontsize=10, weight='bold')
        # Show supplier count below x-axis
        ax.text(bar.get_x() + bar.get_width()/2., -2,
               f'n={int(count)}',
               ha='center', va='top', fontsize=9, style='italic', color='gray')
    
    # Adjust y-axis to make room for labels
    y_max = initiative_success['è¾¾æ ‡ç‡'].max()
    ax.set_ylim(-5, y_max * 1.15)
    
    plt.tight_layout()
    
    output_path = 'CåŒº_å€¡è®®æ•°é‡ä¸æˆåŠŸç‡.png'
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"âœ“ Chart 4 saved: {output_path}")
    
    return fig


# ============================================================================
# Combined Figure: All 4 Charts in One Layout (Optional)
# ============================================================================

def plot_all_combined(budget_df, tech_db, knowledge_db, summary_df):
    """Create a combined figure with all 4 charts"""
    
    fig = plt.figure(figsize=(18, 14))
    gs = fig.add_gridspec(2, 2, hspace=0.35, wspace=0.3)
    
    # Chart 1: Technology Effectiveness (Top Left)
    ax1 = fig.add_subplot(gs[0, 0])
    tech_db_sorted = tech_db.sort_values('å‡æ’ç‡', ascending=True)
    colors_tech = plt.cm.YlGn(np.linspace(0.4, 0.9, len(tech_db_sorted)))
    y_pos = np.arange(len(tech_db_sorted))
    bars1 = ax1.barh(y_pos, tech_db_sorted['å‡æ’ç‡'] * 100,
                     color=colors_tech, alpha=0.85, edgecolor='black', linewidth=1)
    ax1.set_yticks(y_pos)
    ax1.set_yticklabels(tech_db_sorted['æŠ€æœ¯åç§°'], fontsize=9)
    ax1.set_xlabel('å‡æ’ç‡ (%)', fontsize=11, weight='bold')
    ax1.set_title('æŠ€æœ¯å‡æ’æ•ˆæœ\nTechnology Effectiveness', fontsize=13, weight='bold', pad=15)
    ax1.grid(True, alpha=0.3, axis='x', linestyle='--')
    
    # Chart 2: Knowledge Transfer vs Reduction (Top Right)
    ax2 = fig.add_subplot(gs[0, 1])
    scatter = ax2.scatter(budget_df['çŸ¥è¯†è½¬ç§»å¾—åˆ†'],
                         budget_df['å‡æ’ç‡'],
                         s=budget_df['æ€»æŠ•èµ„'] * 0.8,
                         c=budget_df['çŸ¥è¯†å€å¢å™¨'],
                         cmap='plasma',
                         alpha=0.6,
                         edgecolors='black',
                         linewidth=1)
    ax2.set_xlabel('çŸ¥è¯†è½¬ç§»å¾—åˆ† (Knowledge Transfer Score)', fontsize=11, weight='bold')
    ax2.set_ylabel('å‡æ’ç‡ (%)', fontsize=11, weight='bold')
    ax2.set_title('çŸ¥è¯†è½¬ç§»ä¸å‡æ’æ•ˆæœ\nKnowledge Transfer vs Reduction', fontsize=13, weight='bold', pad=15)
    ax2.grid(True, alpha=0.3, linestyle='--')
    cbar = plt.colorbar(scatter, ax=ax2)
    cbar.set_label('çŸ¥è¯†å€å¢å™¨', fontsize=9)
    
    # Add trend line
    z = np.polyfit(budget_df['çŸ¥è¯†è½¬ç§»å¾—åˆ†'], budget_df['å‡æ’ç‡'], 1)
    p = np.poly1d(z)
    x_trend = np.linspace(budget_df['çŸ¥è¯†è½¬ç§»å¾—åˆ†'].min(), budget_df['çŸ¥è¯†è½¬ç§»å¾—åˆ†'].max(), 100)
    ax2.plot(x_trend, p(x_trend), "r--", alpha=0.8, linewidth=2)
    
    # Chart 3: Knowledge Initiative Impact (Bottom Left)
    ax3 = fig.add_subplot(gs[1, 0])
    x_pos = np.arange(len(knowledge_db))
    width = 0.35
    bars3a = ax3.bar(x_pos - width/2, knowledge_db['çŸ¥è¯†å€å¢å™¨'],
                     width, label='çŸ¥è¯†å€å¢å™¨', color='steelblue', alpha=0.85, edgecolor='black')
    bars3b = ax3.bar(x_pos + width/2, knowledge_db['ç½‘ç»œæ•ˆåº”'],
                     width, label='ç½‘ç»œæ•ˆåº”', color='orange', alpha=0.85, edgecolor='black')
    ax3.set_xticks(x_pos)
    ax3.set_xticklabels(knowledge_db['å€¡è®®åç§°'], rotation=25, ha='right', fontsize=9)
    ax3.set_ylabel('æ•ˆæœå€¼', fontsize=11, weight='bold')
    ax3.set_title('çŸ¥è¯†å…±äº«å€¡è®®æ•ˆæœ\nKnowledge Initiative Impact', fontsize=13, weight='bold', pad=15)
    ax3.legend(fontsize=10)
    ax3.grid(True, alpha=0.3, axis='y', linestyle='--')
    
    # Chart 4: Initiatives vs Success Rate (Bottom Right)
    ax4 = fig.add_subplot(gs[1, 1])
    merged_data = pd.merge(budget_df, summary_df, on='ä¾›åº”å•†')
    initiative_success = merged_data.groupby('çŸ¥è¯†å€¡è®®æ•°').agg({
        'æ˜¯å¦è¾¾æ ‡': lambda x: (x == 'æ˜¯').sum() / len(x) * 100 if len(x) > 0 else 0
    }).reset_index()
    initiative_success.columns = ['çŸ¥è¯†å€¡è®®æ•°é‡', 'è¾¾æ ‡ç‡']
    
    bars4 = ax4.bar(initiative_success['çŸ¥è¯†å€¡è®®æ•°é‡'], 
                   initiative_success['è¾¾æ ‡ç‡'],
                   color='seagreen', alpha=0.8, edgecolor='black', linewidth=1.5)
    ax4.plot(initiative_success['çŸ¥è¯†å€¡è®®æ•°é‡'], initiative_success['è¾¾æ ‡ç‡'],
            color='darkgreen', marker='o', linewidth=2.5, markersize=8, alpha=0.7)
    ax4.set_xlabel('çŸ¥è¯†å€¡è®®æ•°é‡', fontsize=11, weight='bold')
    ax4.set_ylabel('è¾¾æ ‡ç‡ (%)', fontsize=11, weight='bold')
    ax4.set_title('å€¡è®®æ•°é‡ä¸æˆåŠŸç‡\nInitiatives vs Success Rate', fontsize=13, weight='bold', pad=15)
    ax4.grid(True, alpha=0.3, axis='y', linestyle='--')
    ax4.set_xticks(initiative_success['çŸ¥è¯†å€¡è®®æ•°é‡'])
    
    for bar, value in zip(bars4, initiative_success['è¾¾æ ‡ç‡']):
        height = bar.get_height()
        ax4.text(bar.get_x() + bar.get_width()/2., height + 0.5,
                f'{value:.1f}%', ha='center', va='bottom', fontsize=9, weight='bold')
    
    plt.suptitle('CåŒºæŠ€æœ¯ä¸çŸ¥è¯†å…±äº«ç»¼åˆåˆ†æ (Zone III: Learning Zone)\nTechnology & Knowledge Sharing Analysis',
                 fontsize=16, weight='bold', y=0.995)
    
    output_path = 'CåŒº_æŠ€æœ¯çŸ¥è¯†ç»¼åˆåˆ†æ_å®Œæ•´ç‰ˆ.png'
    plt.savefig(output_path, dpi=300, bbox_inches='tight', facecolor='white')
    print(f"âœ“ Combined chart saved: {output_path}")
    
    return fig


# ============================================================================
# Main Execution
# ============================================================================

def main():
    print("\n" + "="*80)
    print("STRATEGY C FOCUSED VISUALIZER - Technology & Knowledge Sharing Analysis")
    print("="*80 + "\n")
    
    # Load data
    print("ğŸ“ Loading data files...")
    budget_df, tech_db, knowledge_db, summary_df = load_data()
    
    if budget_df is None:
        return
    
    print(f"\nğŸ“Š Data loaded:")
    print(f"  - {len(budget_df)} budget allocations")
    print(f"  - {len(tech_db)} technologies")
    print(f"  - {len(knowledge_db)} knowledge initiatives")
    print(f"  - {len(summary_df)} summary records")
    
    # Generate individual visualizations
    print("\nğŸ“ˆ Generating focused visualizations...\n")
    
    print("1ï¸âƒ£  Creating technology effectiveness chart...")
    fig1 = plot_technology_effectiveness(tech_db)
    
    print("2ï¸âƒ£  Creating knowledge transfer vs reduction chart...")
    fig2 = plot_knowledge_transfer_vs_reduction(budget_df)
    
    print("3ï¸âƒ£  Creating knowledge initiative impact chart...")
    fig3 = plot_knowledge_initiative_impact(knowledge_db)
    
    print("4ï¸âƒ£  Creating initiatives vs success rate chart...")
    fig4 = plot_initiatives_vs_success_rate(budget_df, summary_df)
    
    print("\n5ï¸âƒ£  Creating combined chart with all 4 visualizations...")
    fig_combined = plot_all_combined(budget_df, tech_db, knowledge_db, summary_df)
    
    print("\n" + "="*80)
    print("âœ… All focused visualizations generated successfully!")
    print("="*80)
    
    # Calculate and display summary statistics
    print("\nğŸ“Š SUMMARY STATISTICS:")
    print(f"  Total Suppliers: {len(summary_df)}")
    print(f"  Success Rate: {(summary_df['æ˜¯å¦è¾¾æ ‡'] == 'æ˜¯').sum() / len(summary_df) * 100:.1f}%")
    print(f"  Average Reduction Rate: {budget_df['å‡æ’ç‡'].mean():.2f}%")
    print(f"  Average Knowledge Multiplier: {budget_df['çŸ¥è¯†å€å¢å™¨'].mean():.2f}x")
    print(f"  Average Network Effect: {budget_df['ç½‘ç»œæ•ˆåº”'].mean():.2f}")
    print(f"  Total Investment: ${budget_df['æ€»æŠ•èµ„'].sum():,.0f}")
    
    # Technology insights
    print(f"\nğŸ”§ TECHNOLOGY INSIGHTS:")
    top_tech = tech_db.nlargest(3, 'å‡æ’ç‡')
    print(f"  Top 3 Most Effective Technologies:")
    for idx, tech in top_tech.iterrows():
        print(f"    â€¢ {tech['æŠ€æœ¯åç§°']}: {tech['å‡æ’ç‡']*100:.1f}% reduction")
    
    # Knowledge initiative insights
    print(f"\nğŸ§  KNOWLEDGE INITIATIVE INSIGHTS:")
    top_initiative = knowledge_db.nlargest(1, 'çŸ¥è¯†å€å¢å™¨')
    print(f"  Highest Knowledge Multiplier:")
    print(f"    â€¢ {top_initiative.iloc[0]['å€¡è®®åç§°']}: {top_initiative.iloc[0]['çŸ¥è¯†å€å¢å™¨']:.2f}x")
    
    top_network = knowledge_db.nlargest(1, 'ç½‘ç»œæ•ˆåº”')
    print(f"  Highest Network Effect:")
    print(f"    â€¢ {top_network.iloc[0]['å€¡è®®åç§°']}: {top_network.iloc[0]['ç½‘ç»œæ•ˆåº”']:.2f}")
    
    plt.show()
    
    print("\nâœ¨ Visualization complete! Charts have been saved to the current directory.")


if __name__ == "__main__":
    main()
